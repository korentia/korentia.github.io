<!DOCTYPE html> <!--[if IE 8]> <html lang="en" class="ie8"> <![endif]--> <!--[if IE 9]> <html lang="en" class="ie9"> <![endif]--> <!--[if !IE]><!--> <html lang="en"> <!--<![endif]--> <head> <title>Google+ Sign-In with Scalatra | Codurance </title> <!-- Meta --> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content="Our team of dedicated software craftsmen provides consultancy, software development, and training services to clients seeking high quality development processes and software solutions."> <meta name="author" content="Codurance Ltd"> <!-- Open Graph tags - Used when publishing on Facebook --> <meta property="og:site_name" content="Codurance"/> <meta property="og:description" content="Our team of dedicated software craftsmen provides consultancy, software development, and training services to clients seeking high quality development processes and software solutions."/> <meta property="og:url" content="http://codurance.com"/> <meta property="og:image" content="http://codurance.com/assets/img/codurance.png"/> <!-- Favicon --> <link rel="shortcut icon" href="/assets/img/favicon.ico"> <!-- CSS Global Compulsory --> <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css"> <link rel="stylesheet" href="/assets/css/style.css"> <link rel="stylesheet" href="/assets/css/blocks.css"> <link rel="stylesheet" href="/assets/css/blog.style.css"> <!-- CSS Implementing Plugins --> <link rel="stylesheet" href="/assets/plugins/line-icons/line-icons.css"> <link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.min.css"> <link rel="stylesheet" href="/assets/plugins/owl.carousel.2.0.0/assets/owl.carousel.css"> <!-- CSS Theme --> <link rel="stylesheet" href="/assets/css/plugins.css"> <link rel="stylesheet" href="/assets/css/app.css"> <link rel="stylesheet" href="/assets/css/pages/blog.css"> <link rel="stylesheet" href="/assets/css/theme-colors/orange.css"> <link rel="stylesheet" href="/assets/css/headers/header-default.css"> <link rel="stylesheet" href="/assets/css/footers/footer-v1.css"> <!-- CSS Customization --> <link rel="stylesheet" href="/assets/css/custom.css"> <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/idea.min.css"> <!--fonts --> <link href='http://fonts.googleapis.com/css?family=Oxygen:700,400' rel='stylesheet' type='text/css'> <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-46289079-1', 'codurance.com'); ga('send', 'pageview'); </script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script> <script>hljs.initHighlightingOnLoad();</script> <!-- ShareThis --> <script type="text/javascript">var switchTo5x=true;</script> <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script> <script type="text/javascript">stLight.options({publisher: "8b795ed1-9577-43d1-9e4e-55c54306336b", doNotHash: true, doNotCopy: false, hashAddressBar: false});</script> </head> <body > <div class="wrapper"> <!--=== Header ===--> <div class="header no-topbar"> <div class="container"> <!-- Logo --> <a class="logo" href="/"> <img class="logo-header" src="/assets/img/codurance.png" alt="Codurance Logo" height="45px;"> </a> <!-- End Logo --> <!-- Toggle get grouped for better mobile display --> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse"> <span class="sr-only">Toggle navigation</span> <span class="fa fa-bars"></span> </button> <!-- End Toggle --> </div><!--/end container--> <!-- Collect the nav links, forms, and other content for toggling --> <div class="collapse navbar-collapse mega-menu navbar-responsive-collapse"> <div class="container"> <ul class="nav navbar-nav"> <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown">Services <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu"> <li><a href="/services/software-creation">Software Creation</a></li> <li><a href="/services/training">Training</a></li> </ul></li> <li><a href="/videos">Videos</a></li> <li><a href="/blog">Blog</a></li> <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown">About Us <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu"> <li><a href="/aboutus/ourteam">Our Team</a></li> <li><a href="/aboutus/ourcompany">Our Company</a></li> <li><a href="/aboutus/ourpractices">Our Practices</a></li> <li><a href="http://www.meetup.com/london-software-craftsmanship">Our Community</a></li> </ul></li> <li><a href="/work-with-us">Work with us</a></li> <li><a href="/aboutus/contact">Contact us</a></li> </ul> </div><!--/end container--> </div><!--/navbar-collapse--> </div> <!--=== End Header ===--> <div class="bg-color-light"> <div class="container content-sm"> <div class="row blog-page blog-item"> <!-- Left Sidebar --> <div class="col-md-9"> <!--Blog Post--> <div class="news-v3 bg-color-white margin-bottom-30"> <div class="news-v3-in shareThisButtons"> <h1>Google+ Sign-In with Scalatra</h1> <ul class="list-inline posted-info"> <li>By <a class='author' href='/blog/author/sandro-mancuso/'>Sandro Mancuso</a></li> <li>Posted 10 Jul 2014</li> <li> <a href="/blog/tag/oauth/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> oauth</span></a> <a href="/blog/tag/google-plus/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> google-plus</span></a> <a href="/blog/tag/scala/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> scala</span></a> <a href="/blog/tag/scalatra/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> scalatra</span></a> <a href="/blog/tag/jade/"><i class="fa fa-tags"></i><span class="blog-tag-margin"> jade</span></a> </li> </ul> <h3>The requirements</h3> <p>For one of our internal pet-projects at Codurance, we decided to have authentication and authorisation using <a href="https://developers.google.com/+/">Google+ Sign-in</a>. Google+ Sign-In is able to authenticate anyone with a Google email account (gmail or business) using OAuth 2.0. However, we wanted to restrict the application to Codurance craftsmen only, that means, people with a Codurance email address.</p> <p>The application had also to redirect us to the desired URL, in case we tried to access a deep URL without being authenticated.</p> <h3>Technology stack</h3> <p>In this project we are using:</p> <ul> <li><a href="http://www.scala-lang.org/">Scala</a></li> <li><a href="http://www.scalatra.org/">Scalatra</a> as a web micro-framework</li> <li><a href="http://jade-lang.com/">Jade</a> as template engine</li> <li><a href="http://www.scala-sbt.org/">sbt</a> as our build tool.</li> <li><a href="https://github.com/json4s/json4s">json4s</a> for JSON manipulation</li> <li><a href="https://github.com/stackmob/newman">Newman</a> as HTTP client library</li> </ul> <h3>Implementation</h3> <h4>Authentication Filter</h4> <p>First we need to add an AuthenticationFilter to our Scalatra application.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">javax.servlet.ServletContext</span>

<span class="k">import</span> <span class="nn">com.codurance.cerebro.controllers.MainController</span>
<span class="k">import</span> <span class="nn">com.codurance.cerebro.security.AuthenticationFilter</span>
<span class="k">import</span> <span class="nn">org.scalatra._</span>

<span class="k">class</span> <span class="nc">ScalatraBootstrap</span> <span class="k">extends</span> <span class="nc">LifeCycle</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="n">init</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ServletContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="n">mount</span><span class="o">(</span><span class="k">new</span> <span class="nc">AuthenticationFilter</span><span class="o">,</span> <span class="s">&quot;/*&quot;</span><span class="o">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">mount</span><span class="o">(</span><span class="k">new</span> <span class="nc">MainController</span><span class="o">,</span> <span class="s">&quot;/*&quot;</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></div> <p>Then, in the AuthenticationFilter, we need to redirect to the sign-in page when we don't have a user in the session. We also need to exclude the pages and URLs that don't need a user to be logged in.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.security</span>

<span class="k">import</span> <span class="nn">org.scalatra.ScalatraFilter</span>

<span class="k">class</span> <span class="nc">AuthenticationFilter</span> <span class="k">extends</span> <span class="nc">ScalatraFilter</span> <span class="o">{</span>
    <span class="n">before</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isProtectedUrl</span> <span class="o">&amp;&amp;</span> <span class="n">userIsNotAuthenticated</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">redirect</span><span class="o">(</span><span class="s">&quot;/signin?originalUri=&quot;</span> <span class="o">+</span> <span class="n">originalURL</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">originalURL</span><span class="o">()</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">getRequestURI</span><span class="o">).</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;/main&quot;</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;/signin&quot;</span><span class="o">))</span> <span class="s">&quot;/main&quot;</span> <span class="k">else</span> <span class="n">url</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">userIsNotAuthenticated</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">request</span><span class="o">.</span><span class="n">getSession</span><span class="o">.</span><span class="n">getAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">isProtectedUrl</span><span class="o">()</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="n">request</span><span class="o">.</span><span class="n">getRequestURI</span><span class="o">();</span>
        <span class="o">!(</span><span class="n">url</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;/signin&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;/authorise&quot;</span><span class="o">)</span> <span class="o">||</span> <span class="n">url</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;/not-authorised&quot;</span><span class="o">))</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></div> <p>For more information about filters, check the <a href="http://www.scalatra.org/">Scalatra</a> documentation.</p> <h4>signin.jade</h4> <p>Then we need a sign-in page, that is displayed when the user is not authenticated.</p> <div class="highlight"><pre><code class="language-jade" data-lang="jade"><span class="p">-</span> <span class="n">attributes</span><span class="o">(</span><span class="s">&quot;title&quot;</span><span class="o">)</span> <span class="k">=</span> <span class="s">&quot;Cerebro&quot;</span>
<span class="p">-</span> <span class="n">attributes</span><span class="o">(</span><span class="s">&quot;layout&quot;</span><span class="o">)</span> <span class="k">=</span> <span class="s">&quot;/WEB-INF/templates/layouts/no-header.jade&quot;</span>

<span class="p">-@ </span><span class="k">val</span> <span class="n">originalUri</span><span class="k">:</span> <span class="kt">String</span>

<span class="nt">h1</span> Welcome to Cerebro!

<span class="nt">p</span><span class="p">=</span> <span class="s">&quot;Please sigin in using google id!&quot;</span>
<span class="nt">p</span> URI: <span class="si">#{</span><span class="n">originalUri</span><span class="si">}</span>

<span class="nd">:!javascript</span>
    <span class="nd">function onSignInCallback(authResult) {</span>
        <span class="nd">if (authResult[&#39;access_token&#39;]) {</span>
            <span class="nd">$.ajax({</span>
                <span class="nd">type: &#39;POST&#39;,</span>
                <span class="nd">url: &#39;/authorise&#39;,</span>
                <span class="nd">contentType: &#39;application/x-www-form-urlencoded; charset=utf-8&#39;,</span>
                <span class="nd">data: {authCode: authResult.code },</span>
                <span class="nd">success: function(result) {</span>
                    <span class="nd">window.location.replace(&#39;</span><span class="si">#{</span><span class="n">originalUri</span><span class="si">}</span><span class="nd">&#39;);</span>
                <span class="nd">},</span>
                <span class="nd">error: function(result) {</span>
                    <span class="nd">window.location.replace(&#39;/not-authorised&#39;);</span>
                <span class="nd">}</span>
            <span class="nd">});</span>
        <span class="nd">}</span>
    <span class="nd">}</span>

<span class="nf">#gConnect</span>
    <span class="nt">button</span>(<span class="na">class=</span><span class="s">&#39;g-signin&#39;</span>
    <span class="na">data-scope=</span><span class="s">&#39;https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.email&#39;</span>
    <span class="na">data-requestvisibleactions=</span><span class="s">&#39;http://schemas.google.com/AddActivity&#39;</span>
    <span class="na">data-clientId=</span><span class="s">&#39;&lt;&lt;YOUR_CLIENT_ID&gt;&gt;&#39;</span>
    <span class="na">data-accesstype=</span><span class="s">&#39;offline&#39;</span> <span class="na">data-callback=</span><span class="s">&#39;onSignInCallback&#39;</span>
    <span class="na">data-theme=</span><span class="s">&#39;dark&#39;</span>
    <span class="na">data-cookiepolicy=</span><span class="s">&#39;single_host_origin&#39;</span>)

<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;https://plus.google.com/js/client:plusone.js&#39;</span>)
<span class="nt">script</span>(<span class="na">src=</span><span class="s">&#39;//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js&#39;</span>)</code></pre></div> <p>If you are not using Jade or want more details, check the <a href="https://developers.google.com/+/web/signin/add-button">official documentation</a> about how to <a href="https://developers.google.com/+/web/signin/add-button">add the sign-in button</a> to your page.</p> <p>This should be enough to trigger the Google authentication form when clicking on the Sign-In button. Once the authentication is done, the callback function will send us a POST with the "authCode".</p> <h4>Main Controller</h4> <p>We then need a controller that will respond to all these requests, displays the respective pages, and do the authorisation.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.controllers</span>

<span class="k">import</span> <span class="nn">javax.servlet.http.</span><span class="o">{</span><span class="nc">HttpServletResponse</span><span class="o">,</span> <span class="nc">HttpServletRequest</span><span class="o">}</span>

<span class="k">class</span> <span class="nc">BaseController</span> <span class="k">extends</span> <span class="nc">CerebroStack</span> <span class="o">{</span>

    <span class="k">def</span> <span class="n">display</span><span class="o">(</span><span class="n">page</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">attributes</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Any</span><span class="o">)*)(</span><span class="k">implicit</span> <span class="n">request</span><span class="k">:</span> <span class="kt">HttpServletRequest</span><span class="o">,</span> <span class="n">response</span><span class="k">:</span> <span class="kt">HttpServletResponse</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
        <span class="n">contentType</span> <span class="k">=</span> <span class="s">&quot;text/html&quot;</span>
        <span class="k">val</span> <span class="n">all_attributes</span> <span class="k">=</span> <span class="n">attributes</span> <span class="o">:+</span> <span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">session</span><span class="o">.</span><span class="n">getAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">))</span>
        <span class="n">jade</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">all_attributes</span><span class="k">:</span> <span class="k">_</span><span class="kt">*</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></div> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.controllers</span>

<span class="k">import</span> <span class="nn">com.codurance.cerebro.security.CoduranceAuthorisation.authorise</span>

<span class="k">import</span> <span class="nn">scala.Predef._</span>

<span class="k">class</span> <span class="nc">MainController</span> <span class="k">extends</span> <span class="nc">BaseController</span> <span class="o">{</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/main&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/signin&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;signin&quot;</span><span class="o">,</span> <span class="s">&quot;originalUri&quot;</span> <span class="o">-&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">getParameter</span><span class="o">(</span><span class="s">&quot;originalUri&quot;</span><span class="o">))</span>
    <span class="o">}</span>

    <span class="n">get</span><span class="o">(</span><span class="s">&quot;/not-authorised&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">display</span><span class="o">(</span><span class="s">&quot;not-authorised&quot;</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="n">post</span><span class="o">(</span><span class="s">&quot;/authorise&quot;</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">authCode</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;authCode&quot;</span><span class="o">,</span> <span class="n">halt</span><span class="o">(</span><span class="mi">400</span><span class="o">))</span>
        <span class="n">authorise</span><span class="o">(</span><span class="n">authCode</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></div> <p>The MainController responds to "/authorise", which invokes the authorisation function defined inside CoduranceAuthorisation. Note that we receive the "authCode" from the Google+ authentication. Once the user was authenticated, we had to make the application available just for users using a Codurance email. For that, we had to invoke the <a href="https://developers.google.com/+/api/latest/people">Google+ People API</a> to get more information (email address, domain, etc).</p> <p>The authorise function would then check if the user belongs to the Codurance domain and add her to the session.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">com.codurance.cerebro.security</span>

<span class="k">import</span> <span class="nn">java.net.URL</span>
<span class="k">import</span> <span class="nn">javax.servlet.http.</span><span class="o">{</span><span class="nc">HttpSession</span><span class="o">,</span> <span class="nc">HttpServletResponse</span><span class="o">,</span> <span class="nc">HttpServletRequest</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">javax.servlet.http.HttpServletResponse._</span>

<span class="k">import</span> <span class="nn">com.google.api.client.googleapis.auth.oauth2.</span><span class="o">{</span><span class="nc">GoogleAuthorizationCodeTokenRequest</span><span class="o">,</span> <span class="nc">GoogleTokenResponse</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">com.google.api.client.http.javanet.NetHttpTransport</span>
<span class="k">import</span> <span class="nn">com.google.api.client.json.jackson.JacksonFactory</span>
<span class="k">import</span> <span class="nn">com.stackmob.newman._</span>
<span class="k">import</span> <span class="nn">com.stackmob.newman.dsl._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.Await</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">object</span> <span class="nc">CoduranceAuthorisation</span> <span class="o">{</span>

    <span class="k">implicit</span> <span class="k">val</span> <span class="n">httpClient</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ApacheHttpClient</span>

    <span class="k">val</span> <span class="nc">GOOGLE_PLUS_PEOPLE_URL</span> <span class="k">=</span> <span class="s">&quot;https://www.googleapis.com/plus/v1/people/me?fields=aboutMe%2Ccover%2FcoverPhoto%2CdisplayName%2Cdomain%2Cemails%2Clanguage%2Cname&amp;access_token=&quot;</span>
    <span class="k">val</span> <span class="nc">CLIENT_ID</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">&quot;&lt;&lt;YOUR_CLIENT_ID&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">CLIENT_SECRET</span> <span class="k">=</span> <span class="s">&quot;&lt;&lt;YOUR_CLIENT_SECRET&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">API_KEY</span> <span class="k">=</span> <span class="s">&quot;&lt;&lt;YOUR_API_KEY&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">APPLICATION_NAME</span> <span class="k">=</span> <span class="s">&quot;&lt;&lt;YOUR_APP_NAME&gt;&gt;&quot;</span>
    <span class="k">val</span> <span class="nc">JSON_FACTORY</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">JacksonFactory</span><span class="o">()</span>
    <span class="k">val</span> <span class="nc">TRANSPORT</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">NetHttpTransport</span><span class="o">()</span>

    <span class="k">def</span> <span class="n">authorise</span><span class="o">(</span><span class="n">authCode</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">session</span><span class="k">:</span> <span class="kt">HttpSession</span><span class="o">,</span> <span class="n">response</span><span class="k">:</span> <span class="kt">HttpServletResponse</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">user</span> <span class="k">=</span> <span class="n">userFor</span><span class="o">(</span><span class="n">authCode</span><span class="o">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">domain</span> <span class="k">match</span> <span class="o">{</span>
            <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">Domain</span><span class="o">(</span><span class="s">&quot;codurance.com&quot;</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="o">{</span>
                <span class="n">session</span><span class="o">.</span><span class="n">setAttribute</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">setStatus</span><span class="o">(</span><span class="nc">SC_OK</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">response</span><span class="o">.</span><span class="n">setStatus</span><span class="o">(</span><span class="nc">SC_UNAUTHORIZED</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">userFor</span><span class="o">(</span><span class="n">authCode</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">tokenResponse</span><span class="k">:</span> <span class="kt">GoogleTokenResponse</span> <span class="o">=</span>
            <span class="k">new</span> <span class="nc">GoogleAuthorizationCodeTokenRequest</span><span class="o">(</span>
                <span class="nc">TRANSPORT</span><span class="o">,</span> <span class="nc">JSON_FACTORY</span><span class="o">,</span> <span class="nc">CLIENT_ID</span><span class="o">,</span> <span class="nc">CLIENT_SECRET</span><span class="o">,</span> <span class="n">authCode</span><span class="o">,</span> <span class="s">&quot;postmessage&quot;</span>
            <span class="o">).</span><span class="n">execute</span>
        <span class="k">val</span> <span class="n">url</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="o">(</span><span class="nc">GOOGLE_PLUS_PEOPLE_URL</span> <span class="o">+</span> <span class="n">tokenResponse</span><span class="o">.</span><span class="n">getAccessToken</span><span class="o">)</span>
        <span class="k">val</span> <span class="n">userInfo</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="nc">GET</span><span class="o">(</span><span class="n">url</span><span class="o">).</span><span class="n">apply</span><span class="o">,</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">)</span>
        <span class="nc">GooglePlusJSONResponseParser</span><span class="o">.</span><span class="n">toUser</span><span class="o">(</span><span class="n">userInfo</span><span class="o">.</span><span class="n">bodyString</span><span class="o">,</span> <span class="n">tokenResponse</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre></div> <p><strong>Note</strong> that in the GOOGLE_PLUS_PEOPLE_URL we specify all the fields we are interested in, including the <em>domain</em> and <em>emails</em>.</p> <p><strong>GooglePlusJSONResponseParser</strong> is a class that we created to parse the JSON response and convert into a User object. We are not showing it in order to keep this post short and focused. You can create your own JSON parser. :)</p> <p><strong>IMPORTANT:</strong> Don't forget to import add the Google+ APIs to your sbt build file.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="s">&quot;com.google.apis&quot;</span> <span class="o">%</span> <span class="s">&quot;google-api-services-oauth2&quot;</span> <span class="o">%</span> <span class="s">&quot;v2-rev59-1.17.0-rc&quot;</span><span class="o">,</span>
    <span class="s">&quot;com.google.apis&quot;</span> <span class="o">%</span> <span class="s">&quot;google-api-services-plus&quot;</span> <span class="o">%</span> <span class="s">&quot;v1-rev115-1.17.0-rc&quot;</span><span class="o">,</span></code></pre></div> <p>That's about it. You now can display the name of the user on all your pages, using a default layout.</p> <div class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="o">-@</span> <span class="k">val</span> <span class="n">title</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">-@</span> <span class="k">val</span> <span class="n">headline</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">title</span>
<span class="o">-@</span> <span class="k">val</span> <span class="n">body</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">-@</span> <span class="k">val</span> <span class="n">user</span><span class="k">:</span> <span class="kt">com.codurance.cerebro.security.User</span>

<span class="o">!!!</span>
<span class="n">html</span>
    <span class="n">head</span>
        <span class="n">title</span><span class="k">=</span> <span class="n">title</span>
    <span class="n">body</span>
        <span class="n">header</span>
            <span class="n">div</span>
                <span class="n">span</span> <span class="nc">Hello</span> <span class="o">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">displayName</span><span class="o">}</span>
        <span class="n">div</span>
            <span class="n">h1</span><span class="k">=</span> <span class="n">headline</span>
            <span class="o">!=</span> <span class="n">body</span></code></pre></div> <div id="sharethisButtons"> <span class='pull-right st_twitter_large' displayText='Tweet' st_url='http://codurance.com/2014/07/10/GooglePlus-sign-in-with-Scala/'></span> <span class='pull-right st_linkedin_large' displayText='LinkedIn' st_url='http://codurance.com/2014/07/10/GooglePlus-sign-in-with-Scala/'></span> <span class='pull-right st_email_large' displayText='Email' st_url='http://codurance.com/2014/07/10/GooglePlus-sign-in-with-Scala/'></span> <span class='pull-right st_sharethis_large' displayText='ShareThis' st_url='http://codurance.com/2014/07/10/GooglePlus-sign-in-with-Scala/'></span> </div> </div> </div> <!--End Blog Post--> <!--About the author--> <div class = "blog-author bg-color-white margin-bottom-30"> <div class="headline headline-md margin-bottom-30"> <h2>About the author</h2> </div> <div class="row"> <div class="col-sm-3 pull-left"> <img class="img-responsive" id="author-img" src="/assets/img/custom/team/sandro_mancuso.jpg"> </div> <div class="col-sm-9"> <div class="blog-author-desc"> <div class="overflow-h"> <h4>Sandro Mancuso</h4> <ul class="list-inline"> <li><a href="https://twitter.com/intent/tweet?text=.%20@sandromancuso%20Type%20your%20text%20here&url=http://codurance.com/2014/07/10/GooglePlus-sign-in-with-Scala/&via=codurance"><i class="fa fa-twitter"></i></a></li> </ul> </div> <p><p>Software craftsman, <a href="http://www.amazon.co.uk/dp/0134052501">author</a>, and founder of the <a href="http://londonswcraft.com">London Software Craftsmanship Community (LSCC)</a>. Sandro has been coding since a very young age but only started his professional career in 1996. He has worked for startups, software houses, product companies, international consultancy companies, and investment banks. </p><p>During his career Sandro had the opportunity to work in a good variety of projects, with different languages, technologies, and across many different industries. Sandro has a lot of experience in bringing the Software Craftsmanship ideology and Extreme Programming practices to organisations of all sizes. Sandro is internationally renowned by his work on evolving and spreading Software Craftsmanship and is frequently invited to speak in many conferences around the world. His professional aspiration is to raise the bar of the software industry by helping developers become better at and care more about their craft.</p></p> </div> </div> </div> </div> <!--End About the author--> </div> <!-- End Left Sidebar --> <!-- Right Sidebar --> <div class="col-md-3"> <!--Related Blog Posts--> <div class="posts margin-bottom-40"> <div class="headline-v2"> <h2>Related Blogs</h2> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2015/11/22/changing-scalatra-and-sbt-directories/"> <img class="rounded-x" src="/assets/img/custom/blog/2015-11-21-folders.jpg" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2015/11/22/changing-scalatra-and-sbt-directories/">Changing Scalatra and sbt default directories</a></h3> <ul class="blog-thumb-info"> <li> Sandro Mancuso </li> </ul> </div> </div> <!--End Related Blog Posts--> </div> <!-- Recent blogs --> <div class="posts margin-bottom-40"> <div class="headline-v2"><h2>Recent Blogs</h2></div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/04/30/akka-basics/"> <img class="rounded-x" src="/assets/img/custom/blog/akka.jpg" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/04/30/akka-basics/">Akka basics</a></h3> <ul class="blog-thumb-info"> <li> Felipe Fernández </li> </ul> </div> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/04/28/async-systems-with-sync-clients/"> <img class="rounded-x" src="/assets/img/custom/blog/time.png" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/04/28/async-systems-with-sync-clients/">Async systems with sync clients</a></h3> <ul class="blog-thumb-info"> <li> Felipe Fernández </li> </ul> </div> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/04/17/sorted-pagination-in-cassandra/"> <img class="rounded-x" src="/assets/img/custom/blog/cassandra.png" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/04/17/sorted-pagination-in-cassandra/">Sorted pagination in Cassandra</a></h3> <ul class="blog-thumb-info"> <li> Felipe Fernández </li> </ul> </div> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/04/12/we-did-it-wrong-but-not-in-vain/"> <img class="rounded-x" src="/assets/img/custom/blog/2016-04-12-we-did-it-wrong.jpg" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/04/12/we-did-it-wrong-but-not-in-vain/">We did it wrong, but not all was in vain</a></h3> <ul class="blog-thumb-info"> <li> Sandro Mancuso </li> </ul> </div> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/03/28/Mutual-Problems/"> <img class="rounded-x" src="/assets/img/custom/blog/2016-03-28-https.jpg" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/03/28/Mutual-Problems/">Mutual Problems</a></h3> <ul class="blog-thumb-info"> <li> Robert Firek </li> </ul> </div> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/03/17/code-smells-part-I/"> <img class="rounded-x" src="/assets/img/custom/blog/code-smells.jpg" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/03/17/code-smells-part-I/">Code Smells – Part I</a></h3> <ul class="blog-thumb-info"> <li> Ana Nogal </li> </ul> </div> </div> <div class="blog-thumb blog-thumb-circle margin-bottom-15"> <div class="blog-thumb-hover"> <a href="/2016/03/16/Containers-all-the-way-through/"> <img class="rounded-x" src="/assets/img/custom/blog/2016-03-16-containers-all-the-way-through/cover-image.png" alt=""></img> </a> <a class="hover-grad" href="blog_single.html"> <i class="fa fa-hand-spock-o"></i> </a> </div> <div class="blog-thumb-desc"> <h3><a href="/2016/03/16/Containers-all-the-way-through/">Containers all the way through...</a></h3> <ul class="blog-thumb-info"> <li> Mani Sarkar </li> </ul> </div> </div> <!-- End Recent blogs --> </div> <!-- End Right Sidebar --> </div> <!--/row--> </div> <!--/container--> </div> <!-- background color --> </div> <!--=== Copyright ===--> <!--=== Footer ===--> <div id="footer-v1" class="footer-v1"> <div class="footer"> <div class="container"> <div class="row"> <!-- About --> <div class="col-md-3 md-margin-bottom-40"> <a href="/"> <img id="logo-footer" class="footer-logo" src="/assets/img/footer-logo.png" alt="Codurance"> </a> <p>Software is our passion. </p> <p>We are software craftsmen. We build well-crafted software for our customers, we help developers to get better at their craft through training, coaching and mentoring, and we help companies get better at delivering software. </p> </div><!--/col-md-3--> <!-- End About --> <!-- Latest --> <div class="col-md-3 md-margin-bottom-40"> <div class="posts"> <div class="headline"><h2>Latest Blogs</h2></div> <ul class="list-unstyled latest-list"> <li> <a href="/2016/04/30/akka-basics/" alt="Akka basics">Akka basics</a> <small>Felipe Fernández</small> </li> <li> <a href="/2016/04/28/async-systems-with-sync-clients/" alt="Async systems with sync clients">Async systems with sync clients...</a> <small>Felipe Fernández</small> </li> <li> <a href="/2016/04/17/sorted-pagination-in-cassandra/" alt="Sorted pagination in Cassandra">Sorted pagination in Cassandra</a> <small>Felipe Fernández</small> </li> </ul> </div> </div><!--/col-md-3--> <!-- End Latest --> <!-- Link List --> <div class="col-md-3 md-margin-bottom-40"> <div class="headline"><h2>Useful Links</h2></div> <ul class="list-unstyled link-list"> <li><a href="/services">Services</a><i class="fa fa-angle-right"></i></li> <li><a href="/videos">Videos</a><i class="fa fa-angle-right"></i></li> <li><a href="/blog">Blog</a><i class="fa fa-angle-right"></i></li> <li><a href="/work-with-us">Work with us</a><i class="fa fa-angle-right"></i></li> <li><a href="/aboutus/ourcompany">About us</a><i class="fa fa-angle-right"></i></li> </ul> </div><!--/col-md-3--> <!-- End Link List --> <!-- Contact Us --> <div class="col-md-3 map-img md-margin-bottom-40"> <div class="headline"><h2>Contact Us</h2></div> <address class="md-margin-bottom-40"> <a href="https://www.google.co.uk/maps/place/I2+Office+Aldersgate/@51.5175798,-0.0978509,19z/data=!4m2!3m1!1s0x0000000000000000:0x71133b028b4f269d" target="_blank">200 Aldersgate, EC1A 4HD<br> London, UK </a><br> Phone: +44 203 440 4015 <br> Email: <a href="mailto:hello@codurance.com" target="_blank" class="">hello@codurance.com</a> </address> </div><!--/col-md-3--> <!-- End Contact Us --> </div> </div> </div><!--/footer--> <div class="copyright"> <div class="container"> <div class="row"> <div class="col-md-6"> <p> Company Registration No: 8712584 </p> </div> <!-- Social Links --> <div class="col-md-6"> <ul class="footer-socials list-inline"> <li> <a href="https://www.facebook.com/codurance/" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Facebook" target="_blank"> <i class="fa fa-facebook"></i> </a> </li> <li> <a href="https://www.linkedin.com/company/codurance" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Linkedin" target="_blank"> <i class="fa fa-linkedin"></i> </a> </li> <li> <a href="https://twitter.com/codurance" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Twitter" target="_blank"> <i class="fa fa-twitter"></i> </a> </li> <li> <a href="/atom.xml" data-original-title="Feed" class="tooltips" data-toggle="tooltip" data-placement="top" title="" target="_blank"> <i class="fa fa-rss"></i> </a> </li> </ul> </div> <!-- End Social Links --> </div> </div> </div><!--/copyright--> </div> <!--=== End Footer ===--> <!--=== End Copyright ===--> </div> <!-- JS Global Compulsory --> <script type="text/javascript" src="/assets/plugins/jquery/jquery.min.js"></script> <script type="text/javascript" src="/assets/plugins/jquery/jquery-migrate.min.js"></script> <script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script> <script type="text/javascript" src="/assets/plugins/back-to-top.js"></script> <!-- JS Implementing Plugins --> <script type="text/javascript" src="/assets/plugins/owl.carousel.2.0.0/owl.carousel.min.js"></script> <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script> <script type="text/javascript" src="/assets/plugins/gmap/gmap.js"></script> <!-- JS Customization --> <script type="text/javascript" src="/assets/js/custom.js"></script> <!-- JS Page Level --> <script type="text/javascript" src="/assets/js/app.js"></script> <script type="text/javascript" src="/assets/js/pages/index.js"></script> <script type="text/javascript"> jQuery(document).ready(function() { App.init(); Contact.initMap(); }); </script> </body> </html>
