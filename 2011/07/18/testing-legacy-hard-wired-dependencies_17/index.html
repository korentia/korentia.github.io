<!DOCTYPE html> <!--[if IE 8]> <html lang="en" class="ie8"> <![endif]--> <!--[if IE 9]> <html lang="en" class="ie9"> <![endif]--> <!--[if !IE]><!--> <html lang="en"> <!--<![endif]--> <head> <title>Testing legacy: Hard-wired dependencies (part 2) | Codurance </title> <!-- Meta --> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content="Our team of dedicated software craftsmen provides consultancy, software development, and training services to clients seeking high quality development processes and software solutions."> <meta name="author" content="Codurance Ltd"> <!-- Open Graph tags - Used when publishing on Facebook --> <meta property="og:site_name" content="Codurance"/> <meta property="og:description" content="Our team of dedicated software craftsmen provides consultancy, software development, and training services to clients seeking high quality development processes and software solutions."/> <meta property="og:url" content="http://codurance.com"/> <meta property="og:image" content="http://codurance.com/assets/img/codurance.png"/> <!-- Favicon --> <link rel="shortcut icon" href="/assets/img/favicon.ico"> <!-- CSS Global Compulsory --> <link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css"> <link rel="stylesheet" href="/assets/css/style.css"> <!-- CSS Implementing Plugins --> <link rel="stylesheet" href="/assets/plugins/line-icons/line-icons.css"> <link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.min.css"> <link rel="stylesheet" href="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.css"> <!-- CSS Theme --> <link rel="stylesheet" href="/assets/css/plugins.css"> <link rel="stylesheet" href="/assets/css/app.css"> <link rel="stylesheet" href="/assets/css/pages/blog.css"> <link rel="stylesheet" href="/assets/css/theme-colors/orange.css" id="style_color"> <!-- CSS Customization --> <link rel="stylesheet" href="/assets/css/custom.css"> <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/styles/idea.min.css"> <!--fonts --> <link href='http://fonts.googleapis.com/css?family=Oxygen:700,400' rel='stylesheet' type='text/css'> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-46289079-1', 'codurance.com'); ga('send', 'pageview'); </script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.8.0/highlight.min.js"></script> <script>hljs.initHighlightingOnLoad();</script> <!-- ShareThis --> <script type="text/javascript">var switchTo5x=true;</script> <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script> <script type="text/javascript" src="http://s.sharethis.com/loader.js"></script> </head> <body> <div class="wrapper"> <!--=== Header ===--> <div class="header-v3 header-sticky"> <!-- Navbar --> <div class="navbar navbar-default" role="navigation"> <div class="container"> <!-- Brand and toggle get grouped for better mobile display --> <div class="navbar-header"> <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse"> <span class="sr-only">Toggle navigation</span> <span class="fa fa-bars"></span> </button> <a class="navbar-brand" href="/"> <img id="logo-header" src="/assets/img/codurance.png" height="45px;" alt="Logo"> </a> </div> <!-- Collect the nav links, forms, and other content for toggling --> <div class="collapse navbar-collapse navbar-responsive-collapse"> <ul class="nav navbar-nav"> <li><a href="/services">Services</a></li> <li><a href="/videos">Videos</a></li> <li><a href="/blog">Blog</a></li> <li><a href="/work-with-us">Work with us</a></li> <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown">About Us <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu"> <li><a href="/aboutus/ourteam">Our Team</a></li> <li><a href="/aboutus/ourcompany">Our Company</a></li> <li><a href="/aboutus/ourpractices">Our Practices</a></li> <li><a href="/aboutus/contact">Contact</a></li> </ul></li> </ul> </div><!--/navbar-collapse--> </div> </div> <!-- End Navbar --> </div> <!--=== End Header ===--> <!--=== End Header ===--> <div class="breadcrumbs"> <div class="container"> <h1 class="pull-left"></h1> <ul class="pull-right breadcrumb"> <li><a href="/">Home</a></li> <li> <a href="/blog">Blog</a> </li> </ul> </div> </div> <div class="container content"> <div class="row blog-page blog-item"> <!-- Left Sidebar --> <div class="col-md-9 md-margin-bottom-60"> <!--Blog Post--> <div class="blog margin-bottom-40"> <h2>Testing legacy: Hard-wired dependencies (part 2)</h2> <div class="blog-post-tags"> <ul class="list-unstyled list-inline blog-info"> <li><i class="fa fa-calendar"></i> 18 Jul 2011</li> <li><i class="fa fa-pencil"></i> Sandro Mancuso</li> </ul> <ul class="list-unstyled list-inline blog-tags"> <li> </li> </ul> </div> <p>In <a href="/2011/07/16/testing-legacy-hard-wired-dependencies/">part one</a>, I showed how to unit test a method that uses a Singleton and makes static calls. So now, let's have a look at common code problems we find in legacy code, using the same example:</p><pre><code>public class TripService {

    public List&lt;Trip&gt; getTripsByUser(User user) throws UserNotLoggedInException {
        List&lt;Trip&gt; tripList = new ArrayList&lt;Trip&gt;();
        User loggedUser = loggedUser();
        boolean isFriend = false;
        if (loggedUser != null) {
            for (User friend : user.getFriends()) {
                if (friend.equals(loggedUser)) {
                    isFriend = true;
                    break;
                }
            }
            if (isFriend) {
                tripList = findTripsByUser(user);
            }
            return tripList;
        } else {
            throw new UserNotLoggedInException();
        }
    }

    protected List&lt;Trip&gt; findTripsByUser(User user) {
        return TripDAO.findTripsByUser(user);
    }

    protected User loggedUser() {
        return UserSession.getInstance().getLoggedUser();
    }

}
</code></pre><p>How many problems can you see? Take your time before reading the ones I found.. :-)</p> <h3>Refactoring</h3> <p><em>NOTE</em>:<em>When I've done it, I've done it step by step running the tests after every step. Here I'll just summarise my decisions</em>.</p> <p>The first thing I noticed is that the tripList variable does not need to be created when the logged user is null, since an exception is thrown and nothing else happens. I've decided to invert the outer if and extract the <a href="http://c2.com/cgi/wiki?GuardClause">guard clause</a>. </p><pre><code>public List&lt;Trip&gt; getTripsByUser(User user) throws UserNotLoggedInException {
    User loggedUser = loggedUser();
    validate(loggedUser);
    List&lt;Trip&gt; tripList = new ArrayList&lt;Trip&gt;();
    boolean isFriend = false;
    for (User friend : user.getFriends()) {
        if (friend.equals(loggedUser)) {
            isFriend = true;
            break;
        }
    }
    if (isFriend) {
        tripList = findTripsByUser(user);
    }
    return tripList;
}

private void validate(User loggedUser) throws UserNotLoggedInException {
    if (loggedUser == null) throw new UserNotLoggedInException();
}
</code></pre><h3>Feature Envy</h3> <p>When a class gets data from another class in order to do some calculation or comparison on that data, quite often it means that the client class <em>envies</em> the other class. This is called <a href="http://c2.com/cgi/wiki?FeatureEnvySmell">Feature Envy (code smell)</a> and it is a very common occurrence in long methods and is everywhere in legacy code. In OO, data and the operations on that data should be on the same object.</p> <p>So, looking at the code above, clearly the whole thing about determining if an user is friends with another doesn't belong to the TripService class. Let's move it to the User class. First the unit test:</p><pre><code>@Test public void
shouldReturnTrueWhenUsersAreFriends() throws Exception {
    User John = new User();
    User Bob = new User();

    John.addFriend(Bob);

    assertTrue(John.isFriendsWith(Bob));
}
</code></pre><p>Now, let's move the code to the User class. Here we can use the Java collections API a bit better and remove the whole for loop and the isFriend flag all together.</p> <p>After a few refactoring steps, here is the new code in the TripService</p><pre><code>public List&lt;Trip&gt; getTripsByUser(User user) throws UserNotLoggedInException {
    User loggedUser = loggedUser();
    validate(loggedUser);
    return (user.isFriendsWith(loggedUser))
                ? findTripsByUser(user)
                : new ArrayList&lt;Trip&gt;();
}
</code></pre><p>Right. This is already much better but it is still not good enough.</p> <h3>Layers and dependencies</h3> <p>Some of you may still be annoyed by the protected methods we created in <a href="/2011/07/17/testing-legacy-hard-wired-dependencies/">part one</a> in order to isolate dependencies and test the class. Changes like that are meant to be temporary, that means, they are done so we can unit test the whole method. Once we have tests covering the method, we can start doing our refactoring and thinking about the dependencies we could inject.</p> <p>Many times we would think that we should just inject the dependency into the class. That sounds obvious. TripService should receive an instance of UserSession. Really?</p> <p>TripService is a service. That means, it dwells in the service layer. UserSession knows about logged users and sessions. It probably talks to the MVC framework and/or HttpSession, etc. Should the TripService be dependant on this class (even if it was an interface instead of being a Singleton)? Probably the whole check if the user is logged in should be done by the controller or whatever the client class may be. In order NOT to change that much (for now) I'll make the TripService receive the logged user as a parameter and remove the dependency on the UserSession completely. I'll need to do some minor changes and clean up in the tests as well.</p> <h3>Naming</h3> <p>No, unfortunately we are not done yet. What does this code do anyway? Return trips from a friend. Looking at the name of the method and parameters, or even the class name, there is no way to know that. The word "friend" is no where to be seen in the TripService's public interface. We need to change that as well.</p> <p>So here is the final code:</p><pre><code>public class TripService {

    public List&lt;Trip&gt; getFriendTrips(User loggedUser, User friend) throws UserNotLoggedInException {
        validate(loggedUser);
        return (friend.isFriendsWith(loggedUser))
                    ? findTripsForFriend(friend)
                    : new ArrayList&lt;Trip&gt;();
    }

    private void validate(User loggedUser) throws UserNotLoggedInException {
        if (loggedUser == null) throw new UserNotLoggedInException();
    }

    protected List&lt;Trip&gt; findTripsForFriend(User friend) {
        return TripDAO.findTripsByUser(friend);
    }
}
</code></pre><p>Better, isn't it? We still have the issue with the other protected method, with the TripDAO static call, etc. But I'll leave this last bit for another post on how to remove dependencies on static methods. I'll park my refactoring for now. We can't refactoring the entire system in one day, right? We still need to deliver some features. :-)</p> <h3>Conclusion</h3> <p>This was just a toy example and may not even make sense. However, it represents many of the problems we find when working with legacy (existing) code. It's amazing how many problems we can find in such a tiny piece of code. Now imagine all those classes and methods with hundreds, if not thousands of lines.</p> <p>We need to keep refactoring our code mercilessly so we never get to a position where we don't understand it any more and the whole <a href="http://craftedsw.blogspot.com/2010/09/bad-code-invisible-threat.html">business starts slowing down</a> because we cannot adjust the software quick enough.</p> <p>Refactoring is not just about extracting methods or making a few tweaks in the logic. We need to think about the dependencies, the responsibilities that each class and method should have, the architectural layers, the design of our application and also the names we give to every class, method, parameter and variable. We should try to have the business domain expressed in the code.</p> <p>We should treat our code base as if it was a <a href="http://craftedsw.blogspot.com/2010/09/bad-code-invisible-threat.html">big garden</a>. If we want it to be pleasant and maintainable, we need to be constantly looking after it.</p> <p>If you haven't read it yet, check the <a href="/2011/07/16/testing-legacy-hard-wired-dependencies/">part one</a> of this post. If you want to give this code a go or find more details about the implementation, check: <a href="https://github.com/sandromancuso/testing_legacy_code">https://github.com/sandromancuso/testing_legacy_code</a></p> </div> <!--End Blog Post--> <!--About the author--> <div class = "margin-bottom-40"> <div class="headline headline-md"> <h2>About the author</h2> </div> <div class="row"> <div class="col-sm-3 pull-left"> <img class="img-responsive" src="/assets/img/custom/team/sandro_mancuso.jpg"> </div> <div class="col-sm-9"> <h3>Sandro Mancuso</h3> <p><p>Software craftsman, <a href="http://leanpub.com/socra">author</a>, and founder of the <a href="http://londonswcraft.com">London Software Craftsmanship Community (LSCC)</a>. Sandro has been coding since a very young age but only started his professional career in 1996. He has worked for startups, software houses, product companies, international consultancy companies, and investment banks. </p><p>During his career Sandro had the opportunity to work in a good variety of projects, with different languages, technologies, and across many different industries. Sandro has a lot of experience in bringing the Software Craftsmanship ideology and Extreme Programming practices to organisations of all sizes. Sandro is internationally renowned by his work on evolving and spreading Software Craftsmanship and is frequently invited to speak in many conferences around the world. His professional aspiration is to raise the bar of the software industry by helping developers become better at and care more about their craft.</p></p> <p> <em> <a target="_blank" href="https://twitter.com/intent/tweet?text=.%20@sandromancuso%20Type%20your%20text%20here&url=http://codurance.com/2011/07/18/testing-legacy-hard-wired-dependencies_17/&via=codurance"> Discuss this article with Sandro Mancuso on Twitter! </a> </em> </p> </div> </div> </div> <!--End About the author--> </div> <!-- End Left Sidebar --> <!-- Right Sidebar --> <div class="col-md-3"> <!--Related Blog Posts--> <div class="posts margin-bottom-40"> <div class="headline headline-md"> <h2>Related Blogs</h2> </div> <!--End Related Blog Posts--> </div> <!-- Recent blogs --> <div class="posts margin-bottom-40"> <div class="headline headline-md"><h2>Recent Blogs</h2></div> <dl class="dl-horizontal"> <dt><a href="/2015/12/13/testing-multithreaded-code-in-java/"><img src="/assets/img/custom/blog/picot.png" alt=""></a></dt> <dd> <p><a href="/2015/12/13/testing-multithreaded-code-in-java/">Testing multithreaded code in Java</a></p> </dd> </dl> <dl class="dl-horizontal"> <dt><a href="/2015/11/25/mouseless-programming/"><img src="/assets/img/custom/blog/dilbert.jpg" alt=""></a></dt> <dd> <p><a href="/2015/11/25/mouseless-programming/">Mouseless Programming</a></p> </dd> </dl> <dl class="dl-horizontal"> <dt><a href="/2015/11/25/Property-based-testing-FsCheck-Resharper-NCrunch-Visual-Studio-2013/"><img src="/assets/img/custom/blog/2015-12-01-Faran-crane-truck.jpg" alt=""></a></dt> <dd> <p><a href="/2015/11/25/Property-based-testing-FsCheck-Resharper-NCrunch-Visual-Studio-2013/">Property based testing with FsCheck, Resharper and NCrunch in Visual Studio 2013</a></p> </dd> </dl> <dl class="dl-horizontal"> <dt><a href="/2015/11/22/changing-scalatra-and-sbt-directories/"><img src="/assets/img/custom/blog/2015-11-21-folders-small.jpg" alt=""></a></dt> <dd> <p><a href="/2015/11/22/changing-scalatra-and-sbt-directories/">Changing Scalatra and sbt default directories</a></p> </dd> </dl> <dl class="dl-horizontal"> <dt><a href="/2015/11/22/my-first-couple-of-months-at-codurance/"><img src="/assets/img/custom/blog/Five Characteristics of a Great Company Culture.jpg" alt=""></a></dt> <dd> <p><a href="/2015/11/22/my-first-couple-of-months-at-codurance/">My first couple of months at Codurance</a></p> </dd> </dl> <dl class="dl-horizontal"> <dt><a href="/2015/11/19/configuring-an-enterprise-app-sucks/"><img src="/assets/img/custom/blog/2015-11-19-configuring-an-enterprise-app-sucks/space-shuttle.jpg" alt=""></a></dt> <dd> <p><a href="/2015/11/19/configuring-an-enterprise-app-sucks/">Configuring an enterprise app sucks</a></p> </dd> </dl> <dl class="dl-horizontal"> <dt><a href="/2015/11/16/tips-for-a-friendly-open-source-experience/"><img src="/assets/img/custom/blog/friendly.png" alt=""></a></dt> <dd> <p><a href="/2015/11/16/tips-for-a-friendly-open-source-experience/">Tips for a friendly open source experience</a></p> </dd> </dl> <!-- End Recent blogs --> </div> <!-- End Right Sidebar --> </div> <!--/row--> </div> <!--/container--> </div> <!-- Sharethis toolbar. Note this will not work in a local environment --> <script type="text/javascript">stLight.options({publisher: "8b795ed1-9577-43d1-9e4e-55c54306336b", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script> <script> var options={ "publisher": "8b795ed1-9577-43d1-9e4e-55c54306336b", "position": "left", "ad": { "visible": false, "openDelay": 5, "closeDelay": 0}, "chicklets": { "items": ["twitter", "linkedin", "googleplus", "facebook", "email"]}}; var st_hover_widget = new sharethis.widgets.hoverbuttons(options); </script> <!-- End Sharethis toolbar --> <!--=== Copyright ===--> <!--=== Footer ===--> <div class="footer-v1"> <div class="footer"> <div class="container"> <div class="row"> <!-- About --> <div class="col-md-3 md-margin-bottom-40"> <a href="/"> <img id="logo-footer" class="footer-logo" src="/assets/img/footer-logo.png" alt="Codurance"> </a> <p>Software is our passion. </p> <p>We are software craftsmen. We build well-crafted software for our customers, we help developers to get better at their craft through training, coaching and mentoring, and we help companies get better at delivering software. </p> </div><!--/col-md-3--> <!-- End About --> <!-- Latest --> <div class="col-md-3 md-margin-bottom-40"> <div class="posts"> <div class="headline"><h2>Latest Blogs</h2></div> <ul class="list-unstyled latest-list"> <li> <a href="/2015/12/13/testing-multithreaded-code-in-java/" alt="Testing multithreaded code in Java">Testing multithreaded code in Java...</a> <small><a class='author' href='/blog/author/felipe-fernández/'>Felipe Fernández</a></small> </li> <li> <a href="/2015/11/25/mouseless-programming/" alt="Mouseless Programming">Mouseless Programming</a> <small><a class='author' href='/blog/author/tomaz-tekavec/'>Tomaz Tekavec</a></small> </li> <li> <a href="/2015/11/25/Property-based-testing-FsCheck-Resharper-NCrunch-Visual-Studio-2013/" alt="Property based testing with FsCheck, Resharper and NCrunch in Visual Studio 2013">Property based testing with FsCheck,...</a> <small><a class='author' href='/blog/author/alessandro-di gioia/'>Alessandro Di Gioia</a></small> </li> </ul> </div> </div><!--/col-md-3--> <!-- End Latest --> <!-- Link List --> <div class="col-md-3 md-margin-bottom-40"> <div class="headline"><h2>Useful Links</h2></div> <ul class="list-unstyled link-list"> <li><a href="/services">Services</a><i class="fa fa-angle-right"></i></li> <li><a href="/videos">Videos</a><i class="fa fa-angle-right"></i></li> <li><a href="/blog">Blog</a><i class="fa fa-angle-right"></i></li> <li><a href="/work-with-us">Work with us</a><i class="fa fa-angle-right"></i></li> <li><a href="/aboutus/ourcompany">About us</a><i class="fa fa-angle-right"></i></li> </ul> </div><!--/col-md-3--> <!-- End Link List --> <!-- Contact Us --> <div class="col-md-3 map-img md-margin-bottom-40"> <div class="headline"><h2>Contact Us</h2></div> <address class="md-margin-bottom-40"> <a href="https://www.google.co.uk/maps/place/I2+Office+Aldersgate/@51.5175798,-0.0978509,19z/data=!4m2!3m1!1s0x0000000000000000:0x71133b028b4f269d" target="_blank">200 Aldersgate, EC1A 4HD<br> London, UK </a><br> Phone: +44 203 440 4015 <br> Email: <a href="mailto:hello@codurance.com" target="_blank" class="">hello@codurance.com</a> </address> </div><!--/col-md-3--> <!-- End Contact Us --> </div> </div> </div><!--/footer--> <div class="copyright"> <div class="container"> <div class="row"> <div class="col-md-6"> <p> Company Registration No: 8712584 </p> </div> <!-- Social Links --> <div class="col-md-6"> <ul class="footer-socials list-inline"> <li> <a href="https://www.facebook.com/codurance/" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Facebook" target="_blank"> <i class="fa fa-facebook"></i> </a> </li> <li> <a href="https://www.linkedin.com/company/codurance" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Linkedin" target="_blank"> <i class="fa fa-linkedin"></i> </a> </li> <li> <a href="https://twitter.com/codurance" class="tooltips" data-toggle="tooltip" data-placement="top" title="" data-original-title="Twitter" target="_blank"> <i class="fa fa-twitter"></i> </a> </li> <li> <a href="/atom.xml" data-original-title="Feed" class="tooltips" data-toggle="tooltip" data-placement="top" title="" target="_blank"> <i class="fa fa-rss"></i> </a> </li> </ul> </div> <!-- End Social Links --> </div> </div> </div><!--/copyright--> </div> <!--=== End Footer ===--> <!--=== End Copyright ===--> </div> <!-- JS Global Compulsory --> <script type="text/javascript" src="/assets/plugins/jquery/jquery.min.js"></script> <script type="text/javascript" src="/assets/plugins/jquery/jquery-migrate.min.js"></script> <script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script> <script type="text/javascript" src="/assets/plugins/back-to-top.js"></script> <!-- JS Implementing Plugins --> <script type="text/javascript" src="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.js"></script> <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script> <script type="text/javascript" src="/assets/plugins/gmap/gmap.js"></script> <!-- JS Customization --> <script type="text/javascript" src="/assets/js/custom.js"></script> <!-- JS Page Level --> <script type="text/javascript" src="/assets/js/app.js"></script> <script type="text/javascript" src="/assets/js/pages/index.js"></script> <script type="text/javascript"> jQuery(document).ready(function() { App.init(); Index.initOwlCarousel(); Contact.initMap(); }); </script> <!--[if lt IE 9]> <script src="/assets/plugins/respond.js"></script> <script src="/assets/plugins/html5shiv.js"></script> <script src="/assets/js/plugins/placeholder-IE-fixes.js"></script> <![endif]--> </body> </html>
